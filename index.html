<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Fiche d‚Äôinventaire SOPAL</title>
  <script src="codeDict.js"></script>
  <script src="codeOFDict.js"></script>
  <script src="codeOFDictSecondaire.js"></script>
  <script src="postConsoCodes.js"></script>
  <script src="stockEncoursData.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    
      @font-face { font-family: 'Arial Narrow'; src: local('Arial Narrow'), local('ArialNarrow'); }
      body { font-family: 'Arial Narrow', Arial, sans-serif; margin: 10px; }

      .header { display: flex; justify-content: space-between; align-items: center; border: 1px solid black; padding: 10px; }
      .logo { font-weight: bold; font-size: 22px; }
      .title-block { text-align: center; flex: 1; }
      .title-block h3 { margin: 0; }
      .section { margin-top: 10px; }

      table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
      th, td { border: 2px solid black; padding: 6px; font-size: 14px; text-align: center; word-wrap: break-word; font-family: 'Arial Narrow', Arial, sans-serif; }
      th { background-color: white; color: black; font-weight: bold; }

      /* Largeurs sp√©cifiques */
      th:nth-child(1), td:nth-child(1) { width: 6%; }   /* Lot */
      th:nth-child(8), td:nth-child(8) { width: 8%; }   /* Quantit√© */
      th:nth-child(9), td:nth-child(9) { width: 6%; }   /* Unit√© */
      th:nth-child(6), td:nth-child(6) { width: 30%; }  /* D√©signation */

      input[type="text"], input[type="number"]{
        width:100%; height:100%; border:none; background:transparent; text-transform:uppercase;
        text-align:center; font-size:14px; padding:0; margin:0; box-sizing:border-box; outline:none;
      }
      select{
        width:100%; height:100%; border:none; background:transparent; text-align:center;
        font-size:14px; padding:0; margin:0; box-sizing:border-box; outline:none;
      }

      .add-button,.delete-button{ font-size:18px; border:none; padding:4px 10px; cursor:pointer; border-radius:4px; }
      .add-button{ background:#28a745; color:#fff; }
      .add-button:disabled{ background:grey; cursor:not-allowed; }
      .add-button:hover:not(:disabled){ background:#218838; }
      .delete-button{ background:#dc3545; color:#fff; margin-left:5px; }
      .delete-button:hover{ background:#c82333; }

      .error{ background:#fdd; color:red; }
      .hidden{ display:none; }
      .warning-text{ color:red; font-weight:bold; }

      .footer-code{ text-align:right; font-size:12px; margin-top:10px; }
      .container{ border:1.5px solid black; padding:20px; font-family:"Times New Roman", Times, serif; }
      .title-block,.section,.checkboxes label,.header,h3,strong,label{ font-family:'Arial Narrow', Arial, sans-serif; }

      /* √âcran vs Impression */
      .print-only{ display:none; }
      .screen-only{ display:table-cell; }

      @media print {
        /* cacher Remarque + boutons uniquement en impression */
        .remarque-header,
        .remarque-cell,
        .no-print { display: none !important; }

        /* remplacer "Code + Version" par 2 colonnes d√©di√©es */
        .print-only { display: table-cell !important; }
        .screen-only { display: none !important; }
      }
      
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">
      <img src="image.png" alt="Groupe SOPAL" style="height: 32px;">
    </div>
    <div class="title-block">
      <h3>Fiche d‚Äôinventaire des encours/Atelier</h3>
      Ann√©e : <input type="text" style="width:80px;"> &nbsp;&nbsp; Page : <input type="text" style="width:30px;"> /
    </div>
  </div>
<div class="section">
  <strong>Atelier :</strong> 
  <input list="listeAteliers" id="atelier" style="width:150px;" required>
  <datalist id="listeAteliers">
    <option value="03">
    <option value="05">
    <option value="06">
    <option value="07">
    <option value="08">
    <option value="09">
    <option value="11">
    <option value="13">
    <option value="16">
    <option value="17">
    <option value="19">
    <option value="21">
    <option value="22">
    <option value="23">
    <option value="24">
  </datalist>

  &nbsp;&nbsp;<strong>Responsable d‚Äôinventaire :</strong> 
  <input type="text" id="responsable" style="width:250px;" readonly required>

  &nbsp;&nbsp;<strong>Poste de travail :</strong> 
  <input type="text" id="poste" style="width:150px;" required>
</div>

<script>
// Tableau associatif : Atelier -> Liste des responsables
const ateliersResponsables = {
  "03": ["Achraf AKROUT"],
  "05": ["Wassim JARRAYA"],
  "06": ["Ali CHAARI"],
  "07": ["Abderrazek REGAYEG"],
  "08": ["Amine KAMMOUN"],
  "09": ["Mohamed FRIKHA"],
  "11": ["Ahmed TURKI"],
  "13": ["Abdellah BOUAZIZ"],
  "16": ["Abdessalem Ben Elhadj"],
  "17": ["Seifeddine KRIAA"],
  "19": ["Tarek LOUATI"],
  "21": ["Majed FESSI"],
  "22": ["Majed FESSI"],
  "23": ["Majed FESSI"],
  "24": ["Majed FESSI"],
};

// S√©lection des √©l√©ments
const atelierInput = document.getElementById("atelier");
const responsableInput = document.getElementById("responsable");

// Remplir automatiquement le responsable quand on choisit un atelier
atelierInput.addEventListener("input", () => {
  const selectedAtelier = atelierInput.value;
  if (ateliersResponsables[selectedAtelier]) {
    responsableInput.value = ateliersResponsables[selectedAtelier][0];
  } else {
    responsableInput.value = ""; // Effacer si atelier invalide
  }
});


</script>


  <div class="section checkboxes">
    <label> Produit semi fini</label> <input type="checkbox">;
    <label> Produit fini</label> <input type="checkbox">;
    <label> Composants</label> <input type="checkbox">;
    <label>MP</label><input type="checkbox"> ;
    <label> Emballage</label><input type="checkbox"> ;
    <label> Consommable</label> <input type="checkbox">;
    <label>Autres <input type="text" style="width:100px;"></label>
  </div>

  <table id="table-inventaire">
    <thead>
      <tr>
        <th>Lot</th>
        <th>Inventaire/emplacement</th>
        <th class="screen-only">Code + Version</th>
        <th class="print-only">Code</th>
        <th class="print-only">Version</th>
        <th>D√©signation</th>
        <th>OF de destination</th>
        <th>Quantit√©</th>
        <th>Unit√©</th>
        <th class="remarque-header hidden">Remarque</th>
        <th class="no-print">‚ûï / üóëÔ∏è</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text"></td>
        <td><input type="text"></td>
        <td class="screen-only"><input type="text" onblur="handleCodeKey(event, this)"></td>
        <td class="print-only"><span class="code-out"></span></td>
        <td class="print-only"><span class="ver-out"></span></td>
        <td><input type="text" readonly></td>
        <td><input type="text" onblur="handleOFKey(event, this)"></td>
        <td><input type="text"></td>
        <td>
          <select>
            <option value="" selected disabled hidden></option>
            <option value="UN">UN</option>
            <option value="KG">KG</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="BA">BA</option>
          </select>
        </td>
        <td class="remarque-cell hidden"><span class="warning-text"></span></td>
        <td class="no-print">
          <button class="add-button" onclick="ajouterLigne(this)" disabled>+</button>
          <button class="delete-button" onclick="supprimerContenuLigne(this)">üóëÔ∏è</button>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="no-print">
    <button class="print-button" onclick="window.print()" style="margin-top: 2cm;">üñ®Ô∏è Imprimer la fiche</button>
    <button onclick="telechargerExcel()" style="margin-top: 10px;">üìä T√©l√©charger Excel</button>
   <button id="save-button"> üíæEnregistrer</button>
   <button onclick="Suivi()"> üëÅÔ∏èSuivi</button>
  </div>
  
</div>
<div class="footer-code">INT51FE13.2</div>
<script>
  function updateRemarqueVisibility() {
    const anyVisible = [...document.querySelectorAll('.remarque-cell .warning-text')]
      .some(span => span && span.textContent.trim() !== '');
    document.querySelectorAll('.remarque-header').forEach(th => th.classList.toggle('hidden', !anyVisible));
    document.querySelectorAll('.remarque-cell').forEach(td => td.classList.toggle('hidden', !anyVisible));
  }

  function handleCodeKey(event, input) {
    const row = input.closest('tr');
    const code = input.value.trim().toUpperCase();
    input.value = code;
    const designationInput = row.querySelectorAll('input')[3];
    const ofInput = row.querySelectorAll('input')[4];
    const addButton = row.querySelector(".add-button");

    if (codeDict[code]) {
      const data = codeDict[code];
      const designation = data.designation || data;
      designationInput.value = designation;
      designationInput.classList.remove("error");
      input.classList.remove("error");

      if (postConsoCodes.includes(code)) {
        ofInput.value = "Article non inventorier";
        addButton.disabled = true;
        row.querySelectorAll("input").forEach((inp, i) => { if (i !== 2) inp.disabled = true; });
      } else {
        addButton.disabled = false;
        ofInput.disabled = false;
      }
    } else {
      designationInput.value = "Code inconnu";
      designationInput.classList.add("error");
      input.classList.add("error");
      addButton.disabled = true;
    }
  }

  function handleOFKey(event, input) {
    const row = input.closest("tr");
    const codeInput = row.querySelector(".screen-only input");
    const code = codeInput.value.trim().toUpperCase();
    const of = input.value.trim().toUpperCase();
    input.value = of;
    const addButton = row.querySelector(".add-button");
    const remarqueSpan = row.querySelector(".warning-text");

    if (postConsoCodes.includes(code)) {
      input.value = "Article non inventorier";
      addButton.disabled = true;
      return;
    }

   const isExactMatch = codeOFDict[code]?.includes(of);
const isOFInSecondaire = codeOFDictSecondaire[code]?.includes(of);


const encoursKey = code + "|" + of;
const isInEncours = stockEncoursData.hasOwnProperty(encoursKey);

const isValid = isExactMatch || isOFInSecondaire || isInEncours;

if (stockEncoursData[encoursKey] !== undefined && stockEncoursData[encoursKey] < 0) {
  remarqueSpan.textContent = "‚ö†Ô∏è manque saisie MAG";
  remarqueSpan.classList.remove("hidden");
} else {
  remarqueSpan.textContent = "";
  remarqueSpan.classList.add("hidden");
}

updateRemarqueVisibility();

if (isValid) {
  input.classList.remove("error");
  codeInput.classList.remove("error");
  addButton.disabled = false;
  row.querySelectorAll("input").forEach(inp => inp.disabled = false);
} else {
  input.classList.add("error");
  codeInput.classList.add("error");
  alert("OF ne correspond pas au code");
  addButton.disabled = true;
  row.querySelectorAll("input").forEach((inp, i) => {
    if (i !== 2 && i !== 4) inp.disabled = true;});
}

  }
  

  function ajouterLigne(bouton) {
    const ligne = bouton.closest("tr");
    const nouvelleLigne = ligne.cloneNode(true);
    nouvelleLigne.querySelectorAll("input").forEach(input => {
      input.value = "";
      input.classList.remove("error");
      input.disabled = false;
    });
    nouvelleLigne.querySelector("select").selectedIndex = 0;
    nouvelleLigne.querySelector("select").disabled = false;
    nouvelleLigne.querySelector(".warning-text").textContent = "";
    nouvelleLigne.querySelector(".warning-text").classList.add("hidden");
    nouvelleLigne.querySelector(".add-button").disabled = true;
    ligne.parentNode.insertBefore(nouvelleLigne, ligne.nextSibling);
    updateRemarqueVisibility();
  }

  function supprimerContenuLigne(bouton) {
    const ligne = bouton.closest("tr");
    ligne.querySelectorAll("input").forEach(input => {
      input.value = "";
      input.disabled = false;
      input.classList.remove("error");
    });
    ligne.querySelector("select").selectedIndex = 0;
    ligne.querySelector("select").disabled = false;
    ligne.querySelector(".warning-text").textContent = "";
    ligne.querySelector(".warning-text").classList.add("hidden");
    ligne.querySelector(".add-button").disabled = true;
    updateRemarqueVisibility();
  }

  function splitCodeVersion(raw) {
    const v = (raw || "").trim().toUpperCase();
    if (!v) return { code: "", version: "" };
    const sepMatch = v.match(/^(.+?)[\s\-_/]+([A-Z0-9.]+)$/);
    if (sepMatch) return { code: sepMatch[1].trim(), version: sepMatch[2].trim() };
    return { code: v, version: "" };
  }

  function fillPrintColumns() {
    const rows = document.querySelectorAll("#table-inventaire tbody tr");
    rows.forEach(row => {
      const codeInput = row.querySelector(".screen-only input");
      const { code, version } = splitCodeVersion(codeInput ? codeInput.value : "");
      const codeSpan = row.querySelector(".print-only .code-out");
      const verSpan  = row.querySelector(".print-only .ver-out");
      if (codeSpan) codeSpan.textContent = code;
      if (verSpan)  verSpan.textContent  = version;
    });
  }

  window.addEventListener("beforeprint", fillPrintColumns);
function telechargerExcel() {
    const table = document.getElementById('table-inventaire');
    const atelier = document.getElementById('atelier').value || "Atelier";
    const responsable = document.getElementById('responsable').value || "Responsable";

    let wb = XLSX.utils.book_new();
    wb.Props = {
        Title: "Fiche d'inventaire",
        Subject: "Inventaire SOPAL",
        Author: "SOPAL",
        CreatedDate: new Date()
    };

    // R√©cup√©rer les donn√©es du tableau
    let data = [];
    const headers = [];
    table.querySelectorAll("thead th").forEach(th => {
        headers.push(th.innerText.trim());
    });
    data.push(headers);

    table.querySelectorAll("tbody tr").forEach(tr => {
        const row = [];
        tr.querySelectorAll("td").forEach(td => {
            const input = td.querySelector("input, select, span");
            if(input) {
                if(input.tagName === "INPUT" || input.tagName === "SELECT") {
                    row.push(input.value);
                } else if(input.tagName === "SPAN") {
                    row.push(input.textContent);
                } else {
                    row.push(td.innerText.trim());
                }
            } else {
                row.push(td.innerText.trim());
            }
        });
        data.push(row);
    });

    // Cr√©er une feuille Excel
    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Inventaire");

    // G√©n√©rer le nom du fichier
    const fileName = `Inventaire_${atelier}_${responsable}.xlsx`;

    // T√©l√©charger le fichier
    XLSX.writeFile(wb, fileName);
}
document.getElementById('save-button').addEventListener('click', function() {
    const atelier = document.getElementById('atelier').value;
    const responsable = document.getElementById('responsable').value;
    const poste = document.getElementById('poste').value;

    if (!atelier || !responsable || !poste) {
        alert("Veuillez remplir tous les champs !");
        return;
    }

    // R√©cup√©rer le tableau d‚Äôinventaire
    const table = document.getElementById('table-inventaire');
    const inventaire = [];
    for (let i = 1; i < table.rows.length; i++) { // ignorer l‚Äôent√™te
        const row = table.rows[i];
        inventaire.push({
            lot: row.cells[0].querySelector('input')?.value || "",
            emplacement: row.cells[1].querySelector('input')?.value || "",
            codeVersion: row.cells[2].querySelector('input')?.value || "",
            code: row.cells[3].querySelector('.code-out')?.textContent || "",
            version: row.cells[4].querySelector('.ver-out')?.textContent || "",
            designation: row.cells[5].querySelector('input')?.value || "",
            ofDest: row.cells[6].querySelector('input')?.value || "",
            quantite: row.cells[7].querySelector('input')?.value || "",
            unite: row.cells[8].querySelector('select')?.value || "",
            remarque: row.cells[9].querySelector('.warning-text')?.textContent || ""
        });
    }

    const fiche = {
        atelier,
        responsable,
        poste,
        date: new Date().toLocaleString(),
        inventaire
    };

    const fiches = JSON.parse(localStorage.getItem('fiches') || '[]');
    fiches.push(fiche);
    localStorage.setItem('fiches', JSON.stringify(fiches));

    alert("Fiche enregistr√©e !");
});

function Suivi() {
    window.location.href = "suivi.html";
}




</script>

</body>
</html>