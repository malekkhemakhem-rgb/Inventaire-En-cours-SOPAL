<!DOCTYPE html> 
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche d‚Äôinventaire SOPAL</title>
<script src="codeDict.js"></script>
<script src="codeOFDict.js"></script>
<script src="codeOFDictSecondaire.js"></script>
<script src="postConsoCodes.js"></script>
<script src="stockEncoursData.js"></script>
<script src="codeDictSuivi.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
@font-face { font-family: 'Arial Narrow'; src: local('Arial Narrow'), local('ArialNarrow'); }
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url('images.JPG') no-repeat center center;
  background-size: cover;
  filter: blur(16px); /* plus flou */
  z-index: -1;
}

body { font-family: 'Arial Narrow', Arial, sans-serif; margin: 10px; }
.header { display: flex; justify-content: space-between; align-items: center; border: 1px solid black; padding: 10px; }
.logo { font-weight: bold; font-size: 22px; }
.title-block { text-align: center; flex: 1; }
.title-block h3 { margin: 0; }
.section { margin-top: 10px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
th, td { border: 2px solid black; padding: 6px; font-size: 14px; text-align: center; word-wrap: break-word; font-family: 'Arial Narrow', Arial, sans-serif; }
th { background-color: white; color: black; font-weight: bold; }
th:nth-child(1), td:nth-child(1) { width: 6%; }
th:nth-child(5), td:nth-child(5) { width: 10%; }
th:nth-child(6), td:nth-child(6) { width: 6%; }
th:nth-child(3), td:nth-child(3) { width: 15%; }
th:nth-child(4), td:nth-child(4) { width: 25%; }
input[type="text"], input[type="number"]{ width:100%; height:100%; border:none; background:transparent; text-transform:uppercase; text-align:center; font-size:14px; padding:0; margin:0; box-sizing:border-box; outline:none; }
select{ width:100%; height:100%; border:none; background:transparent; text-align:center; font-size:14px; padding:0; margin:0; box-sizing:border-box; outline:none; }
.add-button,.delete-button{ font-size:18px; border:none; padding:4px 10px; cursor:pointer; border-radius:4px; }
.add-button{ background:#28a745; color:#fff; }
.add-button:disabled{ background:grey; cursor:not-allowed; }
.add-button:hover:not(:disabled){ background:#218838; }
.delete-button{ background:#dc3545; color:#fff; margin-left:5px; }
.delete-button:hover{ background:#c82333; }
.error{ background:#fdd; color:red; }
.hidden{ display:none; }
.warning-text{ color:red; font-weight:bold; }
.footer-code{ text-align:right; font-size:12px; margin-top:10px; }
.container{ border:1.5px solid black; padding:20px; font-family:"Times New Roman", Times, serif; }
.title-block,.section,.checkboxes label,.header,h3,strong,label{ font-family:'Arial Narrow', Arial, sans-serif; }
.screen-only, .print-only { display: table-cell; }
#save-button {
  background: rgba(255, 255, 255, 0.85);   /* bouton clair */
  color: #0a3d62;
  border: 2px solid transparent;
  padding: 10px 20px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 10px;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
}

/* contour dynamique */
#save-button::before {
  content: "";
  position: absolute;
  inset: -2px;
  border-radius: 12px;
  background: linear-gradient(
    90deg,
    #00c6ff,
    #0072ff,
    #00c6ff
  );
  background-size: 300% 100%;
  z-index: -1;
  animation: borderMove 3s linear infinite;
}
/* Tableau Inventaire et Articles sans OF */
#table-inventaire, #table-sans-of {
  background-color: white; /* fond blanc */
}

#table-inventaire th, #table-inventaire td,
#table-sans-of th, #table-sans-of td {
  background-color: white; /* cellules blanches */
}
#table-inventaire th, #table-sans-of th {
  background-color: #f9f9f9;
}


/* hover */
#save-button:hover {
  background: white;
  transform: scale(1.05);
}

/* animation contour */
@keyframes borderMove {
  0% { background-position: 0% 50%; }
  100% { background-position: 300% 50%; }
}

@media print {
  .remarque-header, .remarque-cell, .no-print { display: none !important; }
  .print-only { display: table-cell !important; }
}
</style>
</head>
<body>

<div class="container">

<div class="header">
  <div class="logo"><img src="image.png" alt="Groupe SOPAL" style="height:32px;"></div>
  <div class="title-block">
    <h3>Fiche d‚Äôinventaire des encours/Atelier</h3>
    Ann√©e : <input type="text" style="width:80px;"> &nbsp;&nbsp; Page : <input type="text" style="width:30px;">
  </div>
</div>

<div class="section">
<strong>Atelier :</strong>
<input list="listeAteliers" id="atelier" style="width:150px;" required>
<datalist id="listeAteliers">
  <option value="03"><option value="05"><option value="06"><option value="07">
  <option value="08"><option value="09"><option value="11"><option value="13">
  <option value="16"><option value="17"><option value="19"><option value="21">
  <option value="22"><option value="23"><option value="24">
</datalist>
&nbsp;&nbsp;<strong>Responsable d‚Äôinventaire :</strong>
<input type="text" id="responsable" style="width:250px;" readonly required>
&nbsp;&nbsp;<strong>Poste de travail :</strong>
<input type="text" id="poste" style="width:150px;" required>
</div>
<style>
  /* Tableau Articles sans OF */
  #table-sans-of th, #table-sans-of td {
    text-align: center;
    padding: 6px;
    border: 1px solid black;
    word-wrap: break-word;
  }

  /* Largeurs des colonnes */
  #table-sans-of th:nth-child(1),
  #table-sans-of td:nth-child(1) { width: 20%; } /* Code Article */
  
  #table-sans-of th:nth-child(2),
  #table-sans-of td:nth-child(2) { width: 40%; } /* D√©signation */
  
  #table-sans-of th:nth-child(3),
  #table-sans-of td:nth-child(3) { width: 15%; } /* Quantit√© */
  
  #table-sans-of th:nth-child(4),
  #table-sans-of td:nth-child(4) { width: 15%; } /* Unit√© */
  
  #table-sans-of th:nth-child(5),
  #table-sans-of td:nth-child(5) { width: 10%; } /* Boutons */
</style>

<script>
// Atelier -> Responsable
const ateliersResponsables = {
  "03":["Achraf AKROUT"],"05":["Wassim JARRAYA"],"06":["Ali CHAARI"],
  "07":["Abderrazek REGAYEG"],"08":["Amine KAMMOUN"],"09":["Mohamed FRIKHA"],
  "11":["Ahmed TURKI"],"13":["Abdellah BOUAZIZ"],"16":["Abdessalem Ben Elhadj"],
  "17":["Seifeddine KRIAA"],"19":["Tarek LOUATI"],"21":["Majed FESSI"],
  "22":["Majed FESSI"],"23":["Majed FESSI"],"24":["Majed FESSI"]
};
const atelierInput=document.getElementById("atelier");
const responsableInput=document.getElementById("responsable");
atelierInput.addEventListener("input",()=>{responsableInput.value=ateliersResponsables[atelierInput.value]?.[0]||"";});

// Firebase
const firebaseConfig = {
  apiKey: "VOTRE_API_KEY",
  authDomain: "VOTRE_PROJECT.firebaseapp.com",
  databaseURL: "https://inventaire-10c24-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "inventaire-10c24",
  storageBucket: "inventaire-10c24.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const fichesRef = db.ref('fiches');
</script>

<div class="section checkboxes">
  <label> Produit semi fini</label> <input type="checkbox">
  <label> Produit fini</label> <input type="checkbox">
  <label> Composants</label> <input type="checkbox">
  <label>MP</label> <input type="checkbox">
  <label> Emballage</label> <input type="checkbox">
  <label> Consommable</label> <input type="checkbox">
  <label>Autres <input type="text" style="width:100px;"></label>
</div>

<table id="table-inventaire">
<thead>
<tr>
  <th>Lot</th>
  <th>Inventaire/emplacement</th>
  <th>Code + Version</th>
  <th>D√©signation</th>
  <th>OF de destination</th>
  <th>Quantit√©</th>
  <th>Unit√©</th>
  <th class="remarque-header hidden">Remarque</th>
  <th class="no-print">‚ûï / üóëÔ∏è</th>
</tr>
</thead>
<tbody>
<tr>
  <td><input type="text"></td>
  <td><input type="text"></td>
  <td><input type="text" onblur="handleCodeKey(event,this)"></td>
  <td><input type="text" readonly></td>
  <td><input type="text" onblur="handleOFKey(event,this)"></td>
  <td><input type="text"></td>
  <td>
    <select>
      <option value="" selected disabled hidden></option>
      <option value="UN">UN</option>
      <option value="KG">KG</option>
      <option value="M">M</option>
      <option value="L">L</option>
      <option value="BA">BA</option>
    </select>
  </td>
  <td class="remarque-cell hidden"><span class="warning-text"></span></td>
  <td class="no-print">
    <button class="add-button" onclick="ajouterLigne(this)" disabled>+</button>
    <button class="delete-button" onclick="supprimerContenuLigne(this)">üóëÔ∏è</button>
  </td>
</tr>
</tbody>
</table>
<div class="section no-print hidden" id="bloc-sans-of" style="margin-top:20px; border:1px solid #ccc; padding:10px; display:none;">
  <h4>‚ö†Ô∏è Composants sans OF üõ†Ô∏è</h4>
  <table id="table-sans-of">
    <thead>
      <tr>
        <th>Code Article</th>
        <th>D√©signation</th>
        <th>Quantit√©</th>
        <th>Unit√©</th>
        <th>‚ûï / üóëÔ∏è</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" class="code-article"></td>
        <td><input type="text" class="designation" readonly></td>
        <td><input type="number"></td>
        <td>
          <select>
            <option value="" selected disabled hidden></option>
            <option value="UN">UN</option>
            <option value="KG">KG</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="BA">BA</option>
          </select>
        </td>
        <td>
          <button class="add-button">+</button>
          <button class="delete-button">üóëÔ∏è</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>



<!-- Bloc pour afficher le nombre d'OF manquants et bouton Valider -->
<div id="of-missing-block" class="no-print" style="margin-top:10px; display:none; border:1px solid #ccc; padding:10px;">
  <span id="of-missing-count"></span>
  <button id="valider-of-missing">Valider tout</button>
</div>
<div class="no-print" style="margin-top:20px;">
  <button id="btn-inserer-sans-of" class="add-button"> üõ†Ô∏è Insertion des composants sans OF</button>
</div>
<!-- Bouton Enregistrer -->
<div class="no-print" style="text-align:center; margin-top:5px; display:flex; flex-direction:column; gap:10px; align-items:center;">
  <button id="save-button">üíæ Enregistrer</button>
  <button id="terminer-button">‚úÖ Terminer saisie</button>
</div>

<div class="no-print"style="text-align:right; margin-top:5px;">
  <button class="print-button" onclick="window.print()" style="margin-top:2cm;">üñ®Ô∏è Imprimer la fiche</button>
  <button onclick="telechargerExcel()" style="margin-top:10px;">üìä T√©l√©charger Excel</button>
  <button id="charger-button">üìÇ Mes saisies pr√©c√©dentes</button>
  <button onclick="Suivi()">üëÅÔ∏èSuivi</button>
  
</div>
<div class="footer-code">INT51FE13.2</div>

<script>
// ===== Fonctions principales =====
function updateRemarqueVisibility() {
  const anyVisible = [...document.querySelectorAll('.remarque-cell .warning-text')]
      .some(span=>span&&span.textContent.trim()!=='');
  document.querySelectorAll('.remarque-header').forEach(th=>th.classList.toggle('hidden',!anyVisible));
  document.querySelectorAll('.remarque-cell').forEach(td=>td.classList.toggle('hidden',!anyVisible));
}

function handleCodeKey(event,input){
  const row=input.closest("tr");
  const code=input.value.trim().toUpperCase();
  input.value=code;
  const designationInput=row.cells[3].querySelector('input');
  const ofInput=row.cells[4].querySelector('input');
  const addButton=row.querySelector(".add-button");

  if(codeDict[code]){
    const data=codeDict[code];
    designationInput.value=data.designation||data;
    designationInput.classList.remove("error");
    input.classList.remove("error");
    if(postConsoCodes.includes(code)){
      ofInput.value="Article non inventorier";
      addButton.disabled=true;
      row.querySelectorAll("input").forEach((inp,i)=>{if(i!==2) inp.disabled=true;});
    } else {
      addButton.disabled=false;
      ofInput.disabled=false;
    }
  } else {
    designationInput.value="Code inconnu";
    designationInput.classList.add("error");
    input.classList.add("error");
    addButton.disabled=true;
  }
}

function handleOFKey(event,input){
  const row=input.closest("tr");
  const codeInput=row.cells[2].querySelector('input');
  const code=codeInput.value.trim().toUpperCase();
  const of=input.value.trim().toUpperCase();
  input.value=of;
  const addButton=row.querySelector(".add-button");
  const remarqueSpan=row.querySelector(".warning-text");

  if(postConsoCodes.includes(code)){
    input.value="Article non inventorier";
    addButton.disabled=true;
    return;
  }

  const isExactMatch=codeOFDict[code]?.includes(of);
  const isOFInSecondaire=codeOFDictSecondaire[code]?.includes(of);
  const encoursKey=code+"|"+of;
  const isInEncours=stockEncoursData.hasOwnProperty(encoursKey);
  const isValid=isExactMatch||isOFInSecondaire||isInEncours;

  if(stockEncoursData[encoursKey]!==undefined&&stockEncoursData[encoursKey]<0){
    remarqueSpan.textContent="‚ö†Ô∏è manque saisie MAG";
    remarqueSpan.classList.remove("hidden");
  } else {
    remarqueSpan.textContent="";
    remarqueSpan.classList.add("hidden");
  }

  updateRemarqueVisibility();

  if(isValid){
    input.classList.remove("error");
    codeInput.classList.remove("error");
    addButton.disabled=false;
    row.querySelectorAll("input").forEach(inp=>inp.disabled=false);
  } else {
    input.classList.add("error");
    codeInput.classList.add("error");
    alert("OF ne correspond pas au code");
    addButton.disabled=true;
    row.querySelectorAll("input").forEach((inp,i)=>{if(i!==2&&i!==4) inp.disabled=true;});
  }
}
function ajouterLigne(bouton) {
  const ligne = bouton.closest("tr");
  const nouvelleLigne = ligne.cloneNode(true);

  // Vider les valeurs
  nouvelleLigne.querySelectorAll("input").forEach(input => {
    input.value = "";
    input.classList.remove("error");
    input.disabled = false;
  });
  nouvelleLigne.querySelector("select").selectedIndex = 0;
  nouvelleLigne.querySelector("select").disabled = false;
  nouvelleLigne.querySelector(".warning-text").textContent = "";
  nouvelleLigne.querySelector(".warning-text").classList.add("hidden");
  nouvelleLigne.querySelector(".add-button").disabled = true;

  // Ajouter la ligne
  ligne.parentNode.insertBefore(nouvelleLigne, ligne.nextSibling);

  // ‚ö° Attacher tous les listeners pour cette ligne
  initialiserLigne(nouvelleLigne);
  updateRemarqueVisibility();
}


function supprimerContenuLigne(bouton) {
  if (!confirm("Supprimer toute la ligne ?")) return;

  const ligne = bouton.closest("tr");
  if (ligne) ligne.remove();

  updateRemarqueVisibility();
}


function telechargerExcel(){
  const table=document.getElementById('table-inventaire');
  const tableSansOF=document.getElementById('table-sans-of');
  const atelier=document.getElementById('atelier').value||"Atelier";
  const responsable=document.getElementById('responsable').value||"Responsable";
  
  let wb=XLSX.utils.book_new();
  wb.Props={ Title:"Fiche d'inventaire", Subject:"Inventaire SOPAL", Author:"SOPAL", CreatedDate:new Date() };
  
  let data=[];
  
  // üîπ En-t√™tes du tableau principal
  const headers=[];
  table.querySelectorAll("thead th").forEach(th=>headers.push(th.innerText.trim()));
  data.push(headers);

  // üîπ Lignes du tableau principal
  table.querySelectorAll("tbody tr").forEach(tr=>{
    const row=[];
    tr.querySelectorAll("td").forEach(td=>{
      const input=td.querySelector("input, select");
      row.push(input?input.value:td.innerText.trim());
    });
    data.push(row);
  });

  // üîπ Lignes du tableau "sans OF" (ajout√©es apr√®s une ligne vide pour s√©parer)
  if(tableSansOF){
    const headersSansOF = [];
    tableSansOF.querySelectorAll("thead th").forEach(th=>headersSansOF.push(th.innerText.trim()));
    data.push([]); // ligne vide pour s√©parer
    data.push(headersSansOF);

    tableSansOF.querySelectorAll("tbody tr").forEach(tr=>{
      const row=[];
      tr.querySelectorAll("td").forEach(td=>{
        const input=td.querySelector("input, select");
        row.push(input?input.value:td.innerText.trim());
      });
      data.push(row);
    });
  }

  // üîπ G√©n√©ration Excel
  const ws=XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb,ws,"Inventaire");
  XLSX.writeFile(wb,`Inventaire_${atelier}_${responsable}.xlsx`);
}


document.getElementById('save-button').addEventListener('click', async function(){
  const atelier = document.getElementById('atelier').value;
  const responsable = document.getElementById('responsable').value;
  const poste = document.getElementById('poste').value;
  if(!atelier || !responsable || !poste){
    alert("Veuillez remplir tous les champs !");
    return;
  }

  // =========================
  // Tableau sans OF (sans doublons)
  // =========================
  const tableSansOF = document.getElementById('table-sans-of');
  if(tableSansOF){
    const inventaireSansOF = [];
    let ligneIncompl√®te = false;

    // üîπ R√©cup√©rer existants depuis Firebase
    const snapshotSansOF = await db.ref('ArticlesSansOF').once('value');
    const existantsSansOF = snapshotSansOF.val() || {};
    const clesExistantesSansOF = new Set();
    Object.values(existantsSansOF).forEach(ligne => {
      clesExistantesSansOF.add(`${ligne.codeArticle}|${ligne.designation}|${ligne.quantite}|${ligne.unite}|${ligne.atelier}`);
    });

    tableSansOF.querySelectorAll("tbody tr").forEach((row, idx) => {
      const code = row.cells[0].querySelector('input')?.value.trim();
      const designation = row.cells[1].querySelector('input')?.value.trim() || "";
      const quantite = row.cells[2].querySelector('input')?.value || "";
      const unite = row.cells[3].querySelector('select')?.value || "";

      if(code){
        if(!designation || !quantite || !unite){
          alert(`Veuillez remplir toutes les cellules obligatoires de la ligne ${idx + 1} du tableau "sans OF" !`);
          ligneIncompl√®te = true;
          return;
        }

        const cleUnique = `${code}|${designation}|${quantite}|${unite}|${atelier}`;
        if(!clesExistantesSansOF.has(cleUnique)){
          inventaireSansOF.push({
            codeArticle: code,
            designation,
            quantite,
            unite,
            atelier,
            responsable,
            date: new Date().toLocaleString()
          });
          clesExistantesSansOF.add(cleUnique);
        }
      }
    });

    if(ligneIncompl√®te) return;

    if(inventaireSansOF.length > 0){
      const refSansOF = db.ref('ArticlesSansOF');
      inventaireSansOF.forEach(item => {
        const newKey = refSansOF.push().key;
        refSansOF.child(newKey).set(item);
      });
      alert(`‚úÖ ${inventaireSansOF.length} article(s) sans OF enregistr√©s (doublons ignor√©s) !`);
    } 
  }

  // =========================
  // Tableau principal (sans doublons)
  // =========================
  const table = document.getElementById('table-inventaire');
  const inventaire = [];
  for(let i = 1; i < table.rows.length; i++){
    const row = table.rows[i];
    inventaire.push({
      lot: row.cells[0].querySelector('input')?.value || "",
      emplacement: row.cells[1].querySelector('input')?.value || "",
      codeVersion: row.cells[2].querySelector('input')?.value || "",
      designation: row.cells[3].querySelector('input')?.value || "",
      ofDest: row.cells[4].querySelector('input')?.value || "",
      quantite: row.cells[5].querySelector('input')?.value || "",
      unite: row.cells[6].querySelector('select')?.value || "",
      remarque: row.cells[7].querySelector('.warning-text')?.textContent || ""
    });
  }

  function inventaireComplet(inventaire){
    const champsOptionnels = ["unite","remarque"];
    for(let i = 0; i < inventaire.length; i++){
      const ligne = inventaire[i];
      for(const champ in ligne){
        if(champsOptionnels.includes(champ)) continue;
        if(ligne[champ] === "" || ligne[champ] === null || ligne[champ] === undefined){
          alert(`Ligne ${i+1} : Le champ "${champ}" est obligatoire et doit √™tre rempli.`);
          return false;
        }
      }
    }
    return true;
  }

  if(!inventaireComplet(inventaire)) return;

  // üîπ Filtrer les doublons existants dans Firebase
  const snapshotPrincipal = await fichesRef.once('value');
  const existantsPrincipal = snapshotPrincipal.val() || {};
  const clesExistantesPrincipal = new Set();
  Object.values(existantsPrincipal).forEach(fiche => {
    if(fiche.inventaire){
      fiche.inventaire.forEach(ligne => {
        clesExistantesPrincipal.add(`${ligne.lot}|${ligne.emplacement}|${ligne.codeVersion}|${ligne.designation}|${ligne.ofDest}|${ligne.quantite}|${ligne.unite}`);
      });
    }
  });

  const nouvellesLignesInventaire = inventaire.filter(ligne => {
    const cleUnique = `${ligne.lot}|${ligne.emplacement}|${ligne.codeVersion}|${ligne.designation}|${ligne.ofDest}|${ligne.quantite}|${ligne.unite}`;
    return !clesExistantesPrincipal.has(cleUnique);
  });

  if(nouvellesLignesInventaire.length === 0){
    alert("‚ÑπÔ∏è Aucun nouvel enregistrement dans le tableau principal (tout est doublon).");
    return;
  }

  // üîπ Enregistrement dans Firebase
  const fiche = {
    atelier,
    responsable,
    poste,
    date: new Date().toLocaleString(),
    inventaire: nouvellesLignesInventaire
  };

  const newKey = fichesRef.push().key;
  fichesRef.child(newKey).set(fiche)
    .then(()=>alert(`‚úÖ Fiche enregistr√©e avec ${nouvellesLignesInventaire.length} nouvelle(s) ligne(s) inventaire !`))
    .catch(err=>alert("‚ùå Erreur lors de l'enregistrement : "+err));
});


// V√©rifie la quantit√© et affiche la remarque
function verifierQuantiteInput(input) {
  const row = input.closest("tr");
  const code = (row.cells[2].querySelector("input").value || "").trim().toUpperCase();
  const of = (row.cells[4].querySelector("input").value || "").trim().toUpperCase();
  const key = of;
  const remarqueSpan = row.querySelector(".warning-text");



  const qteMax = Number(codeDictSuivi[key].qte);
  const qteSaisie = Number(input.value);

  if (isNaN(qteSaisie) || input.value === "") {
    remarqueSpan.textContent = "";
    remarqueSpan.classList.add("hidden");
    updateRemarqueVisibility();
    return;
  }

  if (qteSaisie > qteMax) {
 const pourcentage = (qteSaisie / qteMax).toFixed(2); // 2 d√©cimales
remarqueSpan.textContent = `‚ö†Ô∏è D√©passement : ${pourcentage}%`;
    remarqueSpan.classList.remove("hidden");
  } else {
    remarqueSpan.textContent = "";
    remarqueSpan.classList.add("hidden");
  }

  updateRemarqueVisibility();
}

// Attache l'√©couteur √† toutes les lignes existantes
function ajouterEcouteQuantiteALignesExistantes() {
  document.querySelectorAll("#table-inventaire tbody tr").forEach(row => {
    const inputQte = row.cells[5].querySelector("input");
    if (inputQte) {
      inputQte.removeEventListener("blur", inputQte._verifHandler);
      inputQte._verifHandler = () => verifierQuantiteInput(inputQte);
      inputQte.addEventListener("blur", inputQte._verifHandler);
    }
  });
}

// Attache l'√©couteur √† une nouvelle ligne
function ajouterEcouteQuantite(nouvelleLigne) {
  const inputQte = nouvelleLigne.cells[5].querySelector("input");
  if (inputQte) {
    inputQte._verifHandler = () => verifierQuantiteInput(inputQte);
    inputQte.addEventListener("blur", inputQte._verifHandler);
  }
}

// Appel pour lignes d√©j√† pr√©sentes
ajouterEcouteQuantiteALignesExistantes();

// Exemple : lors de l'ajout d'une nouvelle ligne
function ajouterLigne(bouton) {
  const ligne = bouton.closest("tr");
  const nouvelleLigne = ligne.cloneNode(true);

  // Vider les valeurs
  nouvelleLigne.querySelectorAll("input").forEach(input => {
    input.value = "";
    input.classList.remove("error");
    input.disabled = false;
  });
  nouvelleLigne.querySelector("select").selectedIndex = 0;
  nouvelleLigne.querySelector("select").disabled = false;
  nouvelleLigne.querySelector(".warning-text").textContent = "";
  nouvelleLigne.querySelector(".warning-text").classList.add("hidden");
  nouvelleLigne.querySelector(".add-button").disabled = true;

  // Ajouter la ligne apr√®s l'actuelle
  ligne.parentNode.insertBefore(nouvelleLigne, ligne.nextSibling);

  // Attacher l'√©couteur de quantit√©
  ajouterEcouteQuantite(nouvelleLigne);

  updateRemarqueVisibility();
};
  
function Suivi(){ window.location.href="suivi.html"; }

document.getElementById('terminer-button').addEventListener('click', function () {
  const responsable = document.getElementById('responsable').value;
  const atelier = document.getElementById('atelier').value;

  if (!responsable || !atelier) {
    alert("Veuillez renseigner l'atelier et le responsable !");
    return;
  }

  const table = document.getElementById('table-inventaire');

  // 1Ô∏è‚É£ LIGNES SAISIES (CODE|OF)
  const lignesSaisies = new Set();
  for (let i = 1; i < table.rows.length; i++) {
    const row = table.rows[i];
    const code = row.cells[2].querySelector('input')?.value?.trim().toUpperCase();
    const of   = row.cells[4].querySelector('input')?.value?.trim().toUpperCase();
    if (code && of) {
      lignesSaisies.add(`${code}|${of}`);
    }
  }

  // 2Ô∏è‚É£ OF DE SUIVI (PAR ATELIER)
  const lignesSuivi = Object.keys(codeDictSuivi)
    .filter(key => codeDictSuivi[key].atelier === atelier);

  // 3Ô∏è‚É£ COMPARAISON
  const manquants = lignesSuivi.filter(key => !lignesSaisies.has(key));
  const nbManquants = manquants.length;

  // 4Ô∏è‚É£ AFFICHAGE
  const bloc = document.getElementById('of-missing-block');
  const compteur = document.getElementById('of-missing-count');
  const btnValider = document.getElementById('valider-of-missing');

  if (nbManquants === 0) {
    bloc.style.display = "none";
    alert("‚úÖ Tous les OF sont saisis !");
    return;
  }

  compteur.textContent = `OF manquants : ${nbManquants}`;
  bloc.style.display = "block";

  // üîπ FONCTION UNIQUE POUR VALIDER
btnValider.onclick = function () {

  if (manquants.length === 0) {
    alert("‚úÖ Tous les OF sont d√©j√† saisis !");
    bloc.style.display = "none";
    return;
  }

  const ofManquantsData = manquants.map(key => {
    const [code, of] = key.split("|");
    return {
      codeArticle: code,
      of: of,
      atelier: atelier,
      validePar: responsable,
      dateValidation: new Date().toLocaleString()
    };
  });

  const ofManquantsRef = db.ref('OFManquants');

  // üîπ On r√©cup√®re toutes les donn√©es
  ofManquantsRef.get().then(snapshot => {
    const allData = snapshot.val() || {};

    // üîπ Supprimer uniquement les entr√©es de ce responsable
    Object.keys(allData).forEach(key => {
      if (allData[key].validePar === responsable) {
        ofManquantsRef.child(key).remove();
      }
    });

    // üîπ Ajouter les nouvelles donn√©es pour ce responsable
    ofManquantsData.forEach(item => {
      const newKey = ofManquantsRef.push().key;
      ofManquantsRef.child(newKey).set(item);
    });

    // üîπ Mise √† jour visuelle du tableau
    for (let i = 1; i < table.rows.length; i++) {
      const remarqueSpan = table.rows[i].cells[7]?.querySelector('.warning-text');
      if (remarqueSpan && remarqueSpan.textContent.trim() === "") {
        
        remarqueSpan.style.color = "green";
        remarqueSpan.classList.remove("hidden");
      }
    }

    bloc.style.display = "none";
    alert(`‚úÖ Les OF manquants de ${responsable} ont √©t√© r√©initialis√©s et enregistr√©s !`);
  });
};
});

function initialiserLigne(row) {
  const inputCode = row.cells[2].querySelector("input");
  const inputOF   = row.cells[4].querySelector("input");
  const inputQte  = row.cells[5].querySelector("input");
  const addBtn    = row.querySelector(".add-button");

  if(inputCode) {
    inputCode.addEventListener("blur", () => handleCodeKey(null, inputCode));
  }
  if(inputOF) {
    inputOF.addEventListener("blur", () => handleOFKey(null, inputOF));
  }
  if(inputQte) {
    inputQte._verifHandler = () => verifierQuantiteInput(inputQte);
    inputQte.addEventListener("blur", inputQte._verifHandler);
  }
  if(addBtn) {
    addBtn.disabled = inputCode.value === "" || inputCode.classList.contains("error");
  }
}

document.getElementById('charger-button').addEventListener('click', function () {

  const responsable = document.getElementById('responsable').value;
  const atelier = document.getElementById('atelier').value;

  if (!responsable || !atelier) {
    alert("Veuillez s√©lectionner l'atelier et le responsable.");
    return;
  }

  if (!confirm(`Charger les saisies pr√©c√©dentes de ${responsable} ?`)) return;

  fichesRef
    .orderByChild('responsable')
    .equalTo(responsable)
    .once('value')
    .then(snapshot => {

      if (!snapshot.exists()) {
        alert("Aucune saisie trouv√©e pour ce responsable.");
        return;
      }

      const tbody = document.querySelector('#table-inventaire tbody');
      tbody.innerHTML = ""; // Vider le tableau actuel

      snapshot.forEach(ficheSnap => {
        const fiche = ficheSnap.val();

        if (fiche.atelier !== atelier) return;

        fiche.inventaire.forEach(ligne => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td><input type="text" value="${ligne.lot || ''}"></td>
            <td><input type="text" value="${ligne.emplacement || ''}"></td>
            <td><input type="text" value="${ligne.codeVersion || ''}"></td>
            <td><input type="text" value="${ligne.designation || ''}" readonly></td>
            <td><input type="text" value="${ligne.ofDest || ''}"></td>
            <td><input type="text" value="${ligne.quantite || ''}"></td>
            <td>
              <select>
                <option value=""></option>
                <option value="UN" ${ligne.unite === "UN" ? "selected" : ""}>UN</option>
                <option value="KG" ${ligne.unite === "KG" ? "selected" : ""}>KG</option>
                <option value="M"  ${ligne.unite === "M"  ? "selected" : ""}>M</option>
                <option value="L"  ${ligne.unite === "L"  ? "selected" : ""}>L</option>
                <option value="BA" ${ligne.unite === "BA" ? "selected" : ""}>BA</option>
              </select>
            </td>
            <td class="remarque-cell ${ligne.remarque ? '' : 'hidden'}">
              <span class="warning-text">${ligne.remarque || ''}</span>
            </td>
            <td class="no-print">
              <button class="add-button" onclick="ajouterLigne(this)">+</button>
              <button class="delete-button" onclick="supprimerContenuLigne(this)">üóëÔ∏è</button>
            </td>
          `;
          tbody.appendChild(tr);
          ajouterEcouteQuantite(tr);
        });
      });

      updateRemarqueVisibility();
      alert("‚úÖ Saisies charg√©es avec succ√®s !");
    })
    .catch(err => {
      alert("‚ùå Erreur chargement : " + err.message);
    });
});
function ajouterLigneSansOF(bouton) { 
  const ligne = bouton.closest("tr");
  const nouvelleLigne = ligne.cloneNode(true);

  // Vider les valeurs
  nouvelleLigne.querySelectorAll("input").forEach(input => {
    input.value = "";
    input.classList.remove("error");
  });
  nouvelleLigne.querySelectorAll("select").forEach(sel => sel.selectedIndex = 0);

  // Ajouter la ligne apr√®s l'actuelle
  ligne.parentNode.insertBefore(nouvelleLigne, ligne.nextSibling);

  // ‚ö° Boutons
  const addBtn = nouvelleLigne.querySelector(".add-button");
  addBtn.onclick = () => ajouterLigneSansOF(addBtn);

  const delBtn = nouvelleLigne.querySelector(".delete-button");
  delBtn.onclick = () => supprimerContenuLigne(delBtn);

  // ‚ö° D√©signation automatique
  const codeInput = nouvelleLigne.querySelector(".code-article");
  const designationInput = nouvelleLigne.querySelector(".designation");

  codeInput.addEventListener("blur", () => {
    const code = codeInput.value.trim().toUpperCase();
    codeInput.value = code;
    if(codeDict[code]){
      designationInput.value = codeDict[code].designation || codeDict[code];
    } else {
      designationInput.value = "Code inconnu";
    }
  });
}

// üîπ Supprimer une ligne
function supprimerContenuLigne(bouton){
  if(!confirm("Supprimer cette ligne ?")) return;
  const ligne = bouton.closest("tr");
  if(ligne) ligne.remove();
}

// üîπ Afficher le tableau au clic
const btnInsererSansOF = document.getElementById('btn-inserer-sans-of');
const blocSansOF = document.getElementById('bloc-sans-of');

btnInsererSansOF.addEventListener('click', () => {
  blocSansOF.style.display = 'block';
  blocSansOF.classList.remove('hidden');

  const tbody = blocSansOF.querySelector("tbody");

  // ‚ö° Cr√©er la premi√®re ligne si vide
  if(tbody && tbody.rows.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="text" class="code-article"></td>
      <td><input type="text" class="designation" readonly></td>
      <td><input type="number"></td>
      <td>
        <select>
          <option value="" selected disabled hidden></option>
          <option value="UN">UN</option>
          <option value="KG">KG</option>
          <option value="M">M</option>
          <option value="L">L</option>
          <option value="BA">BA</option>
        </select>
      </td>
      <td>
        <button class="add-button">+</button>
        <button class="delete-button">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // ‚ö° Attacher d√©signation automatique et boutons pour toutes les lignes existantes
  tbody.querySelectorAll("tr").forEach(row => {
    const codeInput = row.querySelector(".code-article");
    const designationInput = row.querySelector(".designation");
    const addBtn = row.querySelector(".add-button");
    const delBtn = row.querySelector(".delete-button");

    if(codeInput && designationInput){
      // √©viter de dupliquer les listeners
      codeInput.replaceWith(codeInput.cloneNode(true));
      const newCodeInput = row.querySelector(".code-article");
      newCodeInput.addEventListener("blur", () => {
        const code = newCodeInput.value.trim().toUpperCase();
        newCodeInput.value = code;
        if(codeDict[code]){
          designationInput.value = codeDict[code].designation || codeDict[code];
        } else {
          designationInput.value = "Code inconnu";
        }
      });
    }

    if(addBtn) addBtn.onclick = () => ajouterLigneSansOF(addBtn);
    if(delBtn) delBtn.onclick = () => supprimerContenuLigne(delBtn);
  });
});




</script>

</body>
</html>
