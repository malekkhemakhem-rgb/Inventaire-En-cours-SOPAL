<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi inventaire (Firebase)</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #000; padding: 8px; text-align: center; }
th { background-color: #f0f0f0; }
button { margin: 2px; padding: 4px 8px; cursor: pointer; }
</style>
</head>
<body>

<h2>Suivi des fiches inventaire</h2>

<button onclick="viderTout()">Vider toutes les fiches</button>

<table>
  <thead>
    <tr>
      <th>Atelier</th>
      <th>Responsable</th>
      <th>Poste</th>
      <th>Date</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="table-fiches"></tbody>
</table>

<script>
// ======================= Firebase configuration =======================
const firebaseConfig = {
    databaseURL: "https://inventaire-10c24-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ======================= Affichage en temps réel =====================
const tbody = document.getElementById("table-fiches");

function afficherFiches(fiches) {
    tbody.innerHTML = ""; // vider table
    fiches.forEach((fiche, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${fiche.atelier}</td>
            <td>${fiche.responsable}</td>
            <td>${fiche.poste}</td>
            <td>${fiche.date}</td>
            <td>
                <button onclick="telechargerExcel('${index}')">Télécharger Excel</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Écouter toutes les fiches dans Firebase en temps réel
db.ref("fiches").on("value", snapshot => {
    const data = snapshot.val() || {};
    const fichesArray = Object.values(data);
    afficherFiches(fichesArray);
});

// ======================= Télécharger Excel ==========================
function telechargerExcel(index) {
    db.ref("fiches").once("value").then(snapshot => {
        const data = snapshot.val();
        const fichesArray = Object.values(data);
        const fiche = fichesArray[index];

        if (!fiche.inventaire || fiche.inventaire.length === 0) {
            alert("Aucune donnée d'inventaire pour cette fiche !");
            return;
        }

        const excelData = fiche.inventaire.map(ligne => ({
            Lot: ligne.lot || "",
            Emplacement: ligne.emplacement || "",
            "Code + Version": ligne.codeVersion || "",
            Code: ligne.code || "",
            Version: ligne.version || "",
            Désignation: ligne.designation || "",
            "OF de destination": ligne.ofDest || "",
            Quantité: ligne.quantite || "",
            Unité: ligne.unite || "",
            Remarque: ligne.remarque || ""
        }));

        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventaire");

        const nom = `Inventaire_${fiche.atelier}_${fiche.responsable.replace(/ /g, "_")}.xlsx`;
        XLSX.writeFile(wb, nom);
    });
}

// ======================= Vider toutes les fiches =====================
function viderTout() {
    if (confirm("Voulez-vous vraiment supprimer toutes les fiches ?")) {
        db.ref("fiches").remove().then(() => {
            alert("Toutes les fiches ont été supprimées !");
        });
    }
}
</script>

</body>
</html>
