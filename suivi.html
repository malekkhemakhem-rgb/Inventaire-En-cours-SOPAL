<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi des inventaires</title>

    <!-- Chart.js pour diagramme -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #999; padding: 8px; text-align: center; }
        th { background: #eee; }
        #detailsBox {
            border: 2px solid #333;
            padding: 15px; margin-top:20px; display:none;
            background: #f9f9f9;
        }
    </style>
</head>
<body>

<h2>üìä Suivi Inventaire</h2>

<canvas id="graphResponsable" height="100"></canvas>

<h3>üìã Liste des saisies</h3>
<table>
    <thead>
        <tr>
            <th>Responsable</th>
            <th>Date</th>
            <th>Nombre de lignes</th>
            <th>Voir</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<div id="detailsBox"></div>

<script type="module">

// ------------------------------------------------------------------------------------
// üî• CONFIG FIREBASE ‚Äî METS TA CONFIG ICI
// ------------------------------------------------------------------------------------
const firebaseConfig = {
  apiKey: "VOTRE_API_KEY",
  authDomain: "VOTRE_PROJECT.firebaseapp.com",
  databaseURL: "https://inventaire-10c24-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "inventaire-10c24",
  storageBucket: "inventaire-10c24.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const fichesRef = db.ref('fiches');

const tbody = document.getElementById("table-fiches");
// ------------------------------------------------------------------------------------

const app = firebase.initializeApp(firebaseConfig);

// Petite fonction utilitaire
function formatDate(timestamp) {
    const d = new Date(timestamp);
    return d.toLocaleDateString("fr-FR") + " " + d.toLocaleTimeString("fr-FR");
}

const tbody = document.getElementById("tableBody");
const detailsBox = document.getElementById("detailsBox");

// ==================================================================
// üì• 1) ON CHARGE TOUTE LA BASE "inventaire"
// ==================================================================
db.ref("inventaire").on("value", function(snapshot) {

    tbody.innerHTML = ""; // vider tableau
    detailsBox.style.display = "none";

    let comptageResponsables = {};

    snapshot.forEach(entry => {

        const item = entry.val();

        // Si format incorrect ‚Üí ignorer
        if (!item || !item.responsable || !item.lignes) return;

        const responsable = item.responsable;
        const date = formatDate(item.timestamp);
        const count = item.lignes.length;

        // comptage pour graph
        comptageResponsables[responsable] = (comptageResponsables[responsable] || 0) + count;

        // ligne tableau
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${responsable}</td>
            <td>${date}</td>
            <td>${count}</td>
            <td><button onclick='voirDetails(${JSON.stringify(item.lignes)})'>Voir</button></td>
        `;
        tbody.appendChild(tr);
    });

    // afficher graph
    afficherGraph(comptageResponsables);
});


// ==================================================================
// üëÅÔ∏è 2) AFFICHER LES D√âTAILS EN TABLEAU
// ==================================================================
window.voirDetails = function(lignes) {

    if (!lignes || lignes.length === 0) {
        detailsBox.style.display = "block";
        detailsBox.innerHTML = "<h3>Aucune ligne</h3>";
        return;
    }

    let html = `
        <h3>üìå D√©tails de la saisie</h3>
        <table>
            <tr>
                <th>Code + Version</th>
                <th>Quantit√©</th>
                <th>D√©signation</th>
                <th>Condition</th>
            </tr>
    `;

    lignes.forEach(row => {
        html += `
            <tr>
                <td>${row.code}</td>
                <td>${row.qte}</td>
                <td>${row.designation}</td>
                <td>${row.condition}</td>
            </tr>
        `;
    });

    html += "</table>";
    detailsBox.innerHTML = html;
    detailsBox.style.display = "block";
};


// ==================================================================
// üìä 3) DIAGRAMME DE BARRES
// ==================================================================
let chartInstance = null;

function afficherGraph(data) {

    const labels = Object.keys(data);
    const valeurs = Object.values(data);

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(
        document.getElementById("graphResponsable"),
        {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "Nombre total de lignes saisies",
                    data: valeurs
                }]
            }
        }
    );
}

</script>

</body>
</html>
