<!DOCTYPE html> 
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi inventaire</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<!-- Chart.js pour le diagramme -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.4.1/chart.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #000; padding: 8px; text-align: center; }
th { background-color: #f0f0f0; }
button { margin: 2px; padding: 4px 8px; cursor: pointer; }
canvas { margin-top: 40px; }
</style>
</head>
<body>

<h2>Suivi des fiches inventaire</h2>

<button onclick="viderTout()">Vider toutes les fiches</button>

<table>
<thead>
<tr>
  <th>Atelier</th>
  <th>Responsable</th>
  <th>Poste</th>
  <th>Date</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="table-fiches"></tbody>
</table>

<h2>ðŸ“Š Diagramme : nombre de lignes par responsable</h2>
<canvas id="barChart" width="600" height="240"></canvas>

<script>
// ===== Firebase setup =====
const firebaseConfig = {
  apiKey: "VOTRE_API_KEY",
  authDomain: "VOTRE_PROJECT.firebaseapp.com",
  databaseURL: "https://inventaire-10c24-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "inventaire-10c24",
  storageBucket: "inventaire-10c24.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const fichesRef = db.ref('fiches');

const tbody = document.getElementById("table-fiches");

// ===== Fonction vider toutes les fiches =====
function viderTout() {
  if(confirm("Voulez-vous vraiment supprimer toutes les fiches ?")) {
    fichesRef.remove()
      .then(() => alert("Toutes les fiches ont Ã©tÃ© supprimÃ©es !"))
      .catch(err => alert("Erreur : " + err));
  }
}

// ===== Diagramme =====
let chart = null;

function updateChart(counts) {
  const labels = Object.keys(counts);
  const values = Object.values(counts);

  if (chart) chart.destroy();

  const ctx = document.getElementById("barChart");

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: "Nombre de lignes saisies",
        data: values
      }]
    }
  });
}

// ===== Ã‰coute Firebase pour mise Ã  jour en temps rÃ©el =====
fichesRef.on('value', snapshot => {
  tbody.innerHTML = "";
  const fiches = snapshot.val();
  const counts = {};  // compteur de lignes par responsable

  if(fiches) {
    Object.keys(fiches).forEach(key => {
      const fiche = fiches[key];

      // ---- compteur lignes ----
      const nb = fiche.inventaire ? fiche.inventaire.length : 0;
      counts[fiche.responsable] = (counts[fiche.responsable] || 0) + nb;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fiche.atelier}</td>
        <td>${fiche.responsable}</td>
        <td>${fiche.poste}</td>
        <td>${fiche.date}</td>
        <td>
          <button onclick="voirFiche('${key}')">Voir</button>
          <button onclick="telechargerExcel('${key}')">TÃ©lÃ©charger Excel</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Mise Ã  jour du graphique
  updateChart(counts);
});

// ===== Voir fiche dans fiche.html =====
function voirFiche(key) {
  localStorage.setItem("fiche_view_key", key);
  window.location.href = "fiche.html";
}

// ===== TÃ©lÃ©charger la fiche en Excel =====
function telechargerExcel(key) {
  fichesRef.child(key).get().then(snapshot => {
    const fiche = snapshot.val();
    if(!fiche || !fiche.inventaire || fiche.inventaire.length === 0) {
      alert("Aucune donnÃ©e d'inventaire pour cette fiche !");
      return;
    }

    const excelData = fiche.inventaire.map(ligne => ({
      Lot: ligne.lot || "",
      Emplacement: ligne.emplacement || "",
      "Code + Version": ligne.codeVersion || "",
      DÃ©signation: ligne.designation || "",
      "OF de destination": ligne.ofDest || "",
      QuantitÃ©: ligne.quantite || "",
      UnitÃ©: ligne.unite || "",
      Remarque: ligne.remarque || ""
    }));

    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventaire");

    const nom = `Inventaire_${fiche.atelier}_${fiche.responsable.replace(/ /g, "_")}.xlsx`;
    XLSX.writeFile(wb, nom);
  }).catch(err => alert("Erreur tÃ©lÃ©chargement : "+err));
}
</script>

</body>
</html>
