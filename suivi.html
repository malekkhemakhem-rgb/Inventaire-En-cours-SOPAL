<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi inventaire</title>
<script src="codeDictSuivi.js"></script>
<script src="codeDictPMP.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: url('images.JPG') no-repeat center center;
  background-size: cover;
  filter: blur(20px);
  z-index: -1;
}


h2, h3 {
  text-align: center;
  color: #001f4d;
  background: rgba(0,31,77,0.4);
  padding: 10px;
  border-radius: 8px;
}

/* Tableaux */
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border:1px solid #000; padding:6px; text-align:center; background-color:#eee7e7; }
button { margin: 2px; padding: 4px 8px; cursor: pointer; }

/* Chart nombres de lignes */
#chart-container { display:flex; justify-content:center; margin-top:30px; }
#chart-responsables { height:400px; width:700px; }

/* Tableau fichiers finaux par atelier */
#atelier-container { 
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;

  margin: 20px auto;      /* üî• centre le tableau horizontalement */
  max-width: 400px;

  background: rgba(255,255,255,0.2);
  padding: 10px;
  border-radius: 8px;
}

#tableExcelAtelier th, #tableExcelAtelier td {
  background: transparent;
  border: 1px solid #000;
  padding: 6px;
  text-align: center;}
  #tableExcelAtelier {
  margin: 20px ;   /* centre horizontalement */
  border-collapse: collapse;
}

/* Boutons T√©l√©charger tout */
#download-button-container { display:flex; justify-content:center; width:100%; }

/* Suivi OF valid√©s */
#chart-of-valides-container {
  display:flex; 
  justify-content:center; 
  margin-top:20px;
}

#chart-of-valides {
  width: 900px;   /* augmenter la largeur */
  height: 500px;  /* augmenter la hauteur */
}


/* Comparaison physique/informatique */
#compare-title { text-align:center; background: rgba(0,31,77,0.4); color: #001f4d; padding:10px; border-radius:8px; width:100%; margin-top:40px; }
</style>
</head>
<body>

<!-- ============================ -->
<!-- Suivi des fiches inventaire -->
<!-- ============================ -->
<h2>Suivi Inventaire des en cours SOPAL</h2>




<div id="chart-container">
  <canvas id="chart-responsables"></canvas>
</div>


<h3>Suivi OF pr√©vus vs saisis</h3>
<div id="chart-of-prevus-container" style="display:flex; justify-content:center; margin-top:20px;">
  <canvas id="chart-of-prevus" width="900" height="500"></canvas>
</div>
<!-- ============================ -->
<!-- Suivi des OF valid√©s -->
<!-- ============================ -->
<h3>Suivi des OF Manquants </h3>
<div style="text-align:right;">
  <button onclick="telechargerExcelOFManquants()">üìä T√©l√©charger Excel</button>
</div>

<!-- Diagramme nombre OF valid√©s par atelier -->
<div id="chart-of-valides-container">
  <canvas id="chart-of-valides"></canvas>
</div>

<!-- Tableau masqu√© -->
<table id="tableau-suivi" style="display:none;">
<thead>
<tr>
  <th>Atelier</th>
  <th>Code Article</th>
  <th>OF</th>
  <th>Valid√© par</th>
  <th>Date de validation</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div class="bande-titre">
  <h3>Composants sans OF par Atelier</h3>
</div>

<div style="width: 20%; margin: auto; margin-top: 10px;">
  <canvas id="pieComposantsSansOF"></canvas>
</div>
<!-- ============================ -->
<!-- Fichiers finaux par atelier -->
<!-- ============================ -->
<h3>Fichiers finaux par atelier</h3>
<div id="atelier-container">
  <table id="tableExcelAtelier"> 
    <thead>
      <tr>
        <th>Atelier</th>
        <th>T√©l√©charger</th>
      </tr>
    </thead>
    <tbody id="excelAtelierBody"></tbody>
  </table>
  <div id="download-button-container">
    <button onclick="telechargerTout()" style="height:40px;">T√©l√©charger tout</button>
  </div>
</div>
<!-- ============================ -->
<!-- Comparaison Physique / Informatique -->
<!-- ============================ -->
<h2 id="compare-title">Comparaison Physique / Informatique</h2>
<label>Fichier de r√©f√©rence :</label>
<input type="file" id="fileRefCompare" accept=".xlsx,.xls"><br><br>
<label>Fichier T√©l√©charger tout :</label>
<input type="file" id="fileCheckCompare" accept=".xlsx,.xls"><br><br>
<button onclick="comparerFichiers()">Comparer et g√©n√©rer Excel</button><br><br>
<button onclick="filtrerRouge()">Afficher seulement les lignes rouges</button>
<button onclick="filtrerBlanc()">Afficher seulement les lignes trouv√©es</button>
<button onclick="resetFiltre()">R√©initialiser filtre</button>

<table id="resultCompareTable">
<thead>
<tr>
  <th>Article</th>
  <th>Atelier</th>
  <th>OF</th>
  <th>Dernier suivi</th>
  <th>Existant ?</th>
</tr>
</thead>
<tbody id="resultCompareBody"></tbody>
</table>
<!-- ============================ -->
<!-- Suivi des fiches inventaire -->
<!-- ============================ -->
<h2>Suivi D√©tails de saisie </h2>
<table id="table-fiches">
<thead>
<tr>
    <th>Code Atelier</th>
  <th>Atelier</th>
  <th>Responsable</th>
  <th>Poste</th>
  <th>Date</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="table-fiches-body"></tbody>
</table>

<script>
// ============================
// Comparaison Excel
// ============================
let referenceData=[], checkData=[];
function readExcel(file, callback){
  const reader=new FileReader();
  reader.onload=(evt)=>{
    const workbook=XLSX.read(evt.target.result,{type:"array"});
    const sheet=workbook.Sheets[workbook.SheetNames[0]];
    callback(XLSX.utils.sheet_to_json(sheet,{defval:""}));
  };
  reader.readAsArrayBuffer(file);
}
document.getElementById('fileRefCompare').addEventListener('change',(e)=>{
  if(e.target.files[0]) readExcel(e.target.files[0], data=>referenceData=data);
});
document.getElementById('fileCheckCompare').addEventListener('change',(e)=>{
  if(e.target.files[0]) readExcel(e.target.files[0], data=>checkData=data);
});

function comparerFichiers(){
  if(referenceData.length===0 || checkData.length===0){ alert("Veuillez charger les deux fichiers !"); return; }
  const tbody=document.getElementById("resultCompareBody");
  tbody.innerHTML="";
  const checkSet=new Set(checkData.map(row=>(row['Code + Version']||"")+"|"+(row['OF de destination']||"")));
  const resultExcel=[];
  referenceData.forEach(ref=>{
    const article=ref['Code article'];
    const of=ref['Num√©ro OF'];
    const atelier=ref['Atelier'];
    const dernierSuivi=ref['Dernier suivi'];
    const key=article+"|"+of;
    const existe=checkSet.has(key);
    const tr=document.createElement("tr");
    if(!existe) tr.style.backgroundColor="#ff9999";
    [article,atelier,of,dernierSuivi,existe?"Existant":"Inexistant"].forEach(v=>{
      const td=document.createElement("td");
      td.textContent=v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
    resultExcel.push({Article:article,Atelier:atelier,OF:of,'Dernier suivi':dernierSuivi,Existant:existe?"Existant":"Inexistant"});
  });
  const ws=XLSX.utils.json_to_sheet(resultExcel);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Comparaison");
  XLSX.writeFile(wb,"Comparaison_OF.xlsx");
}
function filtrerRouge(){[...document.querySelectorAll("#resultCompareBody tr")].forEach(tr=>{tr.style.display=tr.style.backgroundColor==="rgb(255, 153, 153)"?"":"none";});}
function filtrerBlanc(){[...document.querySelectorAll("#resultCompareBody tr")].forEach(tr=>{tr.style.display=tr.style.backgroundColor==="rgb(255, 153, 153)"?"none":"";});}
function resetFiltre(){[...document.querySelectorAll("#resultCompareBody tr")].forEach(tr=>{tr.style.display="";});}

// ============================
// Firebase et inventaire
// ============================
const PASSWORD="PLN2025";
window.addEventListener("load",()=>{
  let saisie=prompt("Veuillez entrer le mot de passe pour acc√©der √† cette page :");
  if(saisie!==PASSWORD){ alert("Mot de passe incorrect ! Redirection vers la page d'accueil."); window.location.href="inv.html"; }
});

const firebaseConfig={
  apiKey:"VOTRE_API_KEY",
  authDomain:"VOTRE_PROJECT.firebaseapp.com",
  databaseURL:"https://inventaire-10c24-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId:"inventaire-10c24",
  storageBucket:"inventaire-10c24.appspot.com",
  messagingSenderId:"SENDER_ID",
  appId:"APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const fichesRef=db.ref('fiches');
const ofManquantsRef=db.ref('OFManquants');

const tbodyFiches=document.getElementById("table-fiches-body");
const atelierNoms={
  "03":"ESTAMPAGE","05":"USINAGE 1","06":"USINAGE 2","07":"POLISSAGE 1","08":"POLISSAGE 2","09":"TRAITEMENT DE SURFACE",
  "11":"POLISSAGE 4","13":"ASSEMBLAGE 1","16":"FONDERIE","17":"ASSEMBLAGE 2","19":"USINAGE 3","21":"INJECTION TYNA",
  "22":"ESTAMPAGE TYNA","23":"USINAGE TYNA","24":"ASSEMBLAGE TYNA"
};

// ============================
// Gestion des fiches
// ============================
function viderTout(){if(confirm("Voulez-vous vraiment supprimer toutes les fiches ?")){fichesRef.remove().then(()=>alert("Toutes les fiches ont √©t√© supprim√©es !")).catch(err=>alert("Erreur : "+err));}}

function telechargerExcel(key){
  fichesRef.child(key).get().then(snapshot=>{
    const fiche=snapshot.val();
    if(!fiche||!fiche.inventaire||fiche.inventaire.length===0){alert("Aucune donn√©e !"); return;}
   const excelData = fiche.inventaire.map(l => {
  return {
    "Code Atelier": fiche.atelier,
    Atelier: atelierNoms[fiche.atelier] || fiche.atelier,
    Responsable: fiche.responsable,
    Poste: fiche.poste,
    Date: fiche.date,

    Lot: l.hasOwnProperty("lot") ? l.lot : "",
    Emplacement: l.hasOwnProperty("emplacement") ? l.emplacement : "",

    "Code + Version": l.codeVersion || "",
    D√©signation: l.designation || "",
    "OF de destination": l.ofDest || "",
    Quantit√©: l.quantite || "",
    Unit√©: l.unite || "",
    Remarque: l.remarque || ""
  }
  });
    const ws=XLSX.utils.json_to_sheet(excelData);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Inventaire");
    XLSX.writeFile(wb,`Inventaire_${atelierNoms[fiche.atelier]||fiche.atelier}_${fiche.responsable.replace(/ /g,"_")}.xlsx`);
  });
}

function telechargerExcelAtelier(at,fiches){
  let lignes=[];
  Object.values(fiches).forEach(f=>{
    if(f.atelier==at && f.inventaire){
      lignes=lignes.concat(f.inventaire.map(l=>({
        "Code Atelier":f.atelier, Atelier:atelierNoms[f.atelier]||f.atelier,
        Responsable:f.responsable,Poste:f.poste,Date:f.date,
          Lot: l.hasOwnProperty("lot") ? l.lot : "",
    Emplacement: l.hasOwnProperty("emplacement") ? l.emplacement : "",

    "Code + Version": l.codeVersion || "",
    D√©signation: l.designation || "",
    "OF de destination": l.ofDest || "",
    Quantit√©: l.quantite || "",
    Unit√©: l.unite || "",
    Remarque: l.remarque || ""
      })));
    }
  });
  if(lignes.length===0){alert("Aucune ligne pour cet atelier !"); return;}
  const ws=XLSX.utils.json_to_sheet(lignes);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Inventaire_Atelier");
  XLSX.writeFile(wb,`Inventaire_${atelierNoms[at]||at}.xlsx`);
}

function telechargerTout(){
  fichesRef.get().then(snapshot=>{
    const fiches=snapshot.val()||{};
    let lignes=[];
    Object.values(fiches).forEach(f=>{
      if(f.inventaire){
        lignes=lignes.concat(f.inventaire.map(l=>({
          Atelier:atelierNoms[f.atelier]||f.atelier, Responsable:f.responsable,   Lot: l.hasOwnProperty("lot") ? l.lot : "",
    Emplacement: l.hasOwnProperty("emplacement") ? l.emplacement : "",

    "Code + Version": l.codeVersion || "",
    D√©signation: l.designation || "",
    "OF de destination": l.ofDest || "",
    Quantit√©: l.quantite || "",
    Unit√©: l.unite || "",
    Remarque: l.remarque || ""
        })));
      }
    });
    if(lignes.length===0){alert("Aucune donn√©e !"); return;}
    const ws=XLSX.utils.json_to_sheet(lignes);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Inventaire_Tout");
    XLSX.writeFile(wb,"Inventaire_Tout_Ateliers.xlsx");
  });
}

fichesRef.on('value',snapshot=>{
  tbodyFiches.innerHTML="";
  const fiches=snapshot.val()||{};
  const compteAteliers={};
  const atelierSet=new Set();
  const excelBody=document.getElementById("excelAtelierBody");
  excelBody.innerHTML="";
  Object.keys(fiches).forEach(key=>{
    const f=fiches[key];
    const nomAtelier=atelierNoms[f.atelier]||f.atelier;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${f.atelier}</td><td>${nomAtelier}</td><td>${f.responsable}</td><td>${f.poste}</td><td>${f.date}</td>
      <td><button onclick="telechargerExcel('${key}')">T√©l√©charger Excel</button></td>`;
    tbodyFiches.appendChild(tr);
    compteAteliers[f.atelier]=(compteAteliers[f.atelier]||0)+f.inventaire.length;
    atelierSet.add(f.atelier);
  });
  atelierSet.forEach(at=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${atelierNoms[at]||at}</td><td><button onclick='telechargerExcelAtelier("${at}", ${JSON.stringify(fiches)})'>T√©l√©charger</button></td>`;
    excelBody.appendChild(tr);
  });
  updateChart(compteAteliers);
});

// ============================
// Suivi OF manquants
// ============================
function afficherOFManquants() {
  const tbody = document.querySelector("#tableau-suivi tbody");
  tbody.innerHTML = "";
  return ofManquantsRef.once('value')
    .then(snapshot => {
      if (!snapshot.exists()) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align:center">Aucun OF valid√© trouv√©</td>`;
        tbody.appendChild(tr);
        return;
      }
      snapshot.forEach(itemSnap => {
        const item = itemSnap.val();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.atelier || ""}</td>
          <td>${item.codeArticle || ""}</td>
          <td>${item.of || ""}</td>
          <td>${item.validePar || ""}</td>
          <td>${item.dateValidation || ""}</td>
        `;
        tbody.appendChild(tr);
      });
      afficherChartOFValides(snapshot.val());
    })
    .catch(err => {
      console.error("Erreur r√©cup√©ration OF manquants :", err);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" style="text-align:center; color:red;">Erreur lors de la r√©cup√©ration</td>`;
      tbody.appendChild(tr);
    });
}


// Diagramme nombre OF valid√©s par atelier
function afficherChartOFValides(data){
  const compte={};
  Object.values(data||{}).forEach(item=>{
    const at=item.atelier;
    compte[at]=(compte[at]||0)+1;
  });
  const ctx=document.getElementById('chart-of-valides').getContext('2d');
  new Chart(ctx,{
    type:'bar',
    data:{
      labels:Object.keys(compte).map(a=>atelierNoms[a]||a),
      datasets:[{label:'OF valid√©s',data:Object.values(compte),backgroundColor:'#001f4d'}]
    },
    options:{
      responsive:false,
      plugins:{title:{display:true,text:'Nombre d\'OF Non compt√®es/Atelier',font:{size:16,weight:'bold'},color:'#001f4d'}},
      scales:{y:{beginAtZero:true,stepSize:1}}
    }
  });
}

// T√©l√©charger Excel OFManquants
function telechargerExcelOFManquants(){
  ofManquantsRef.get().then(snapshot=>{
    const data=snapshot.val();
    if(!data){alert("Aucune donn√©e !"); return;}
    const excelData=Object.values(data).map(item=>({
      Atelier:item.atelier, "Code Article":item.codeArticle, OF:item.of, "Valid√© par":item.validePar, "Date validation":item.dateValidation
    }));
    const ws=XLSX.utils.json_to_sheet(excelData);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"OFManquants");
    XLSX.writeFile(wb,"OFManquants.xlsx");
  });
}

// ============================
// Chart nombre de lignes par atelier
// ============================
let chartInstance = null;
function updateChart(data){
  const ctx = document.getElementById('chart-responsables').getContext('2d');
  const labels = Object.keys(data); // üîπ utiliser le code atelier directement
  const values = Object.values(data);
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'bar',
    data:{
      labels,
      datasets:[{
        label:'Nombre de lignes',
        data: values,
        backgroundColor:'#001f4d',
        barThickness:75,
        maxBarThickness:75,
        categoryPercentage:0.6,
        barPercentage:0.9
      }]
    },
    options:{
      responsive:false,
      maintainAspectRatio:false,
      indexAxis:'x',
      plugins:{
        title:{
          display:true,
          text:'üìä Nombre de lignes saisies par atelier',
          color:"#001f4d",
          font:{size:18,weight:'bold'}
        }
      },
      scales:{
        y:{beginAtZero:true,stepSize:1,ticks:{precision:0,font:{size:14}}},
        x:{ticks:{font:{size:10}}}
      }
    }
  });
}

function afficherChartOFPrevusVsSaisis() {
  const dictSuivi = {};

  // 1Ô∏è‚É£ compter OF pr√©vus par atelier
  Object.values(codeDictSuivi).forEach(item => {
    const at = item.atelier;
    if (!dictSuivi[at]) dictSuivi[at] = { prevu: 0, saisi: 0 };
    dictSuivi[at].prevu += 1;
  });

  // 2Ô∏è‚É£ r√©cup√©rer les OF saisis depuis les fiches Firebase
  fichesRef.get().then(snapshot => {
    const fiches = snapshot.val() || {};
    Object.values(fiches).forEach(fiche => {
      if (fiche.inventaire) {
        const at = fiche.atelier;
        if (!dictSuivi[at]) dictSuivi[at] = { prevu: 0, saisi: 0 };
        dictSuivi[at].saisi += fiche.inventaire.length;
      }
    });

    // 3Ô∏è‚É£ cr√©er le diagramme
    const ctx = document.getElementById('chart-of-prevus').getContext('2d');
    const labels = Object.keys(dictSuivi).map(a => atelierNoms[a] || a);
    const dataPrevus = Object.keys(dictSuivi).map(a => dictSuivi[a].prevu);
    const dataSaisis = Object.keys(dictSuivi).map(a => dictSuivi[a].saisi);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'OF pr√©vus', data: dataPrevus, backgroundColor: 'rgba(255, 99, 132, 0.5)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 },
          { label: 'OF saisis', data: dataSaisis, backgroundColor: 'rgba(75, 192, 75, 0.6)', borderColor: 'rgb(75, 192, 75)', borderWidth: 1 }
        ]
      },
      options: {
        responsive: false,
        plugins: {
          title: { display: true, text: 'Suivi OF pr√©vus vs saisis par atelier', font: { size: 16, weight: 'bold' } },
          legend: { position: 'top' }
        },
        scales: { y: { beginAtZero: true, stepSize: 1 } }
      }
    });
  });
}

// Au lieu de : const db = firebase.database();
genererGraphiqueComposantsSansOF();

function genererGraphiqueComposantsSansOF() {
  // utilise la variable db d√©j√† existante
  const refSansOF = db.ref('ArticlesSansOF');

  refSansOF.once('value').then(snapshot => {
    const data = snapshot.val() || {};
    const countParAtelier = {};

    Object.values(data).forEach(item => {
      const atelier = item.atelier || "Inconnu";
      if (!countParAtelier[atelier]) countParAtelier[atelier] = 0;
      countParAtelier[atelier]++;
    });

    const labels = Object.keys(countParAtelier);
    const values = Object.values(countParAtelier);

    const ctx = document.getElementById('pieComposantsSansOF').getContext('2d');

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: 'Composants sans OF',
          data: values,
          backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40']
        }]
      },
      options: {
    responsive: true,
    plugins: {
        legend: { position: 'bottom' },
        title: {
            display: true,
            text: 'Nombre de Composants sans OF par Atelier',
            color: '#001f4d', // üíô couleur du titre
            font: {
                size: 18,     // taille du texte
                weight: 'bold' // gras
            }
        }
    }
}
    });
  });
}



// Afficher OFManquants au chargement
// Afficher OFManquants et le diagramme au chargement
document.addEventListener("DOMContentLoaded", function() {
  afficherOFManquants().then(() => {
    
    afficherChartOFPrevusVsSaisis();  
    
      
  });
});

</script>
</body>
</html>
