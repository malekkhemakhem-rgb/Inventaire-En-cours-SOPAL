<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi Inventaire</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #000; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    button { margin: 2px; padding: 4px 8px; cursor: pointer; }
    canvas { margin-top: 40px; }
  </style>
</head>
<body>

<h2>Suivi des fiches inventaire</h2>

<!-- Bouton supprimer -->
<button onclick="viderTout()">Vider toutes les fiches</button>

<!-- Tableau -->
<table>
  <thead>
    <tr>
      <th>Atelier</th>
      <th>Responsable</th>
      <th>Poste</th>
      <th>Date</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="table-fiches"></tbody>
</table>

<hr>

<h2>üìä Diagramme : Nombre de lignes saisies par responsable</h2>
<canvas id="barChart" width="600" height="250"></canvas>

<script>
/* -----------------------------
    üî• Firebase CONFIG
------------------------------*/
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "000000000",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -----------------------------
    üßπ Fonction : vider tout
------------------------------*/
function viderTout() {
  if (confirm("Supprimer toutes les fiches ?")) {
      db.ref("inventaire").remove();
      document.getElementById("table-fiches").innerHTML = "";
      alert("Toutes les fiches ont √©t√© supprim√©es !");
  }
}

/* -----------------------------
    üì• Chargement des fiches
------------------------------*/
const tbody = document.getElementById("table-fiches");

db.ref("inventaire").on("value", snap => {
    tbody.innerHTML = "";
    const data = snap.val() || {};

    // Pour graphe
    const counts = {}; // responsable ‚Üí nb de lignes

    Object.keys(data).forEach(id => {
        const fiche = data[id];

        // calcul lignes pour diagramme
        const nb = fiche.inventaire ? fiche.inventaire.length : 0;
        counts[fiche.responsable] = (counts[fiche.responsable] || 0) + nb;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${fiche.atelier || ""}</td>
            <td>${fiche.responsable || ""}</td>
            <td>${fiche.poste || ""}</td>
            <td>${fiche.date || ""}</td>
            <td>
                <button onclick="voir('${id}')">Voir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Mise √† jour graphe
    updateChart(counts);
});

/* -----------------------------
    üëÅÔ∏è Voir fiche
------------------------------*/
function voir(id) {
    localStorage.setItem("fiche_view_id", id);
    window.location.href = "fiche.html";
}

/* -----------------------------
    üìä GRAPHIQUE BARRES
------------------------------*/
let chart = null;

function updateChart(counts) {
    const labels = Object.keys(counts);
    const values = Object.values(counts);

    if (chart) chart.destroy(); // √©viter superposition

    const ctx = document.getElementById("barChart");

    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: "Nombre de lignes saisies",
                data: values
            }]
        }
    });
}
</script>

</body>
</html>
