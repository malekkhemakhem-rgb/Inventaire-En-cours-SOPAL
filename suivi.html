<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi inventaire</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #000; padding: 8px; text-align: center; }
th { background-color: #f0f0f0; }
button { margin: 2px; padding: 4px 8px; cursor: pointer; }
#chart-container { margin-top: 40px; width: 100%; max-width: 800px; }
#chart-responsables { height: 400px; }
</style>
</head>
<body>

<h2>Suivi des fiches inventaire</h2>

<button onclick="viderTout()">Vider toutes les fiches</button>

<table>
<thead>
<tr>
  <th>Atelier</th>
  <th>Responsable</th>
  <th>Poste</th>
  <th>Date</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="table-fiches"></tbody>
</table>

<div id="chart-container">
  <canvas id="chart-responsables"></canvas>
</div>
<script>
// Mot de passe pour accÃ©der Ã  la page
const PASSWORD = "PLN2025"; // â† change ton mot de passe ici

// Demander le mot de passe dÃ¨s le chargement de la page
window.addEventListener("load", () => {
    let saisie = prompt("Veuillez entrer le mot de passe pour accÃ©der Ã  cette page :");
    if (saisie !== PASSWORD) {
        alert("Mot de passe incorrect ! Redirection vers la page d'accueil.");
        window.location.href = "inv.html"; // ou une autre page de redirection
    }
});
</script>

<script>
// ===== Firebase setup =====
const firebaseConfig = {
  apiKey: "VOTRE_API_KEY",
  authDomain: "VOTRE_PROJECT.firebaseapp.com",
  databaseURL: "https://inventaire-10c24-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "inventaire-10c24",
  storageBucket: "inventaire-10c24.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const fichesRef = db.ref('fiches');

const tbody = document.getElementById("table-fiches");

// ===== Fonction vider toutes les fiches =====
function viderTout() {
  if(confirm("Voulez-vous vraiment supprimer toutes les fiches ?")) {
    fichesRef.remove()
      .then(() => alert("Toutes les fiches ont Ã©tÃ© supprimÃ©es !"))
      .catch(err => alert("Erreur : " + err));
  }
}

// ===== Fonction voir fiche =====
function voirFiche(key) {
  localStorage.setItem("fiche_view_key", key);
  window.location.href = "fiche.html"; // page fiche Ã  crÃ©er
}

// ===== TÃ©lÃ©charger la fiche Excel =====
function telechargerExcel(key) {
  fichesRef.child(key).get().then(snapshot => {
    const fiche = snapshot.val();
    if(!fiche || !fiche.inventaire || fiche.inventaire.length === 0) {
      alert("Aucune donnÃ©e d'inventaire pour cette fiche !");
      return;
    }

    const excelData = fiche.inventaire.map(ligne => ({
      Lot: ligne.lot || "",
      Emplacement: ligne.emplacement || "",
      "Code + Version": ligne.codeVersion || "",
      DÃ©signation: ligne.designation || "",
      "OF de destination": ligne.ofDest || "",
      QuantitÃ©: ligne.quantite || "",
      UnitÃ©: ligne.unite || "",
      Remarque: ligne.remarque || ""
    }));

    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventaire");

    const nom = `Inventaire_${fiche.atelier}_${fiche.responsable.replace(/ /g, "_")}.xlsx`;
    XLSX.writeFile(wb, nom);
  }).catch(err => alert("Erreur tÃ©lÃ©chargement : "+err));
}

// ===== Ã‰coute Firebase pour mise Ã  jour en temps rÃ©el =====
fichesRef.on('value', snapshot => {
  tbody.innerHTML = "";
  const fiches = snapshot.val();
  const compteResponsables = {}; // pour le diagramme
  if(fiches) {
    Object.keys(fiches).forEach(key => {
      const fiche = fiches[key];
      // remplir tableau
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fiche.atelier}</td>
        <td>${fiche.responsable}</td>
        <td>${fiche.poste}</td>
        <td>${fiche.date}</td>
        <td>
          <button onclick="voirFiche('${key}')">Voir</button>
          <button onclick="telechargerExcel('${key}')">TÃ©lÃ©charger Excel</button>
        </td>
      `;
      tbody.appendChild(tr);

      // compter lignes pour chaque responsable
      compteResponsables[fiche.responsable] = (compteResponsables[fiche.responsable] || 0) + fiche.inventaire.length;
    });
  }
  // ===== Diagramme =====
  updateChart(compteResponsables);
});

// ===== Diagramme avec Chart.js =====
let chartInstance = null;
function updateChart(data) {
  const ctx = document.getElementById('chart-responsables').getContext('2d');
  const labels = Object.keys(data);
  const values = Object.values(data);

  // ajuster hauteur du canvas en fonction du nombre de lignes (2cm par ligne)
  const hauteurParLigne = 20; // px â‰ˆ 2cm pour l'Ã©cran
  const totalHeight = Math.max(hauteurParLigne * labels.length, 100);
  document.getElementById('chart-responsables').height = totalHeight;

  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Nombre de lignes saisies',
        data: values,
        backgroundColor: '#28a745'
      }]
    },
     options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        title: {
          display: true,
          text: 'ðŸ“Š Nombre de lignes saisies par responsable',
          font: { size: 20, weight: 'bold' }
        }
      },
      scales: {
        x: { beginAtZero: true, stepSize: 1 },
        y: { ticks: { font: { size: 14 } } }
      }
    }
  });
}
</script>
</body>
</html>
